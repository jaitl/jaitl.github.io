---
title: "Databases CAP"
author: ""
type: ""
date: 2022-01-15T12:00:00+03:00
subtitle: ""
image: ""
tags: []
private: false
---
Ещё одна статья про CAP-теорему. Я прочитал около 10 статей на тему CAP-теоремы и хочу обобщить полученную информацию.
<!--more-->

## CAP
Теорема состоит из трех свойств.

### Consistency (Согласованность)
У CAP теоремы, достаточно строгое понимание согласованности, она понимает Sequential consistency или Linearizability. Каждая нода всегда должна отдавать самые последние данные.
Под это определение подходит только синхронная репликация между нодами. Асинхронная репликация гарантирует только Eventual Consistency, что не подходит под определение Consistency в CAP.

### Availability (Доступность)
По CAP, если нода не упала и она возвращает хоть какой то ответ, то нода считается доступной. Но в CAP не учитывается лейтенси, если нода отвечала 10 минут, но это ок и по CAP эта нода считается доступной.

### Partition tolerance (Устойчивость к разделению)
Система продолжает работать, даже если возникли сетевые проблемы, например две ноды не видят друг друга.

## Репликация
Перед тем как приступать к объяснению комбинаций свойств нужно понять как синхронизируются данные между нодами баз данных. 

### master-slave
Это самый простой вариант. Есть одна главная нода - `master` базы данных, которая обрабатывает запросы на запись и чтение данных. К главной ноде подключены еще N дополнительных нод-реплик - `slave`, которые являются копиями `master` ноды. Реплики обрабатывают только запросы на чтение, в реплику нельзя записать данные. Когда новые данные добавляются в `master` ноду, они отправляются во все `slave` ноды в синхронном или асинхронном режиме в зависимости от конфигурации.

Если `master` нода выходит из строя, то выбирается реплика и становится новой `master` нодой. После этого все запросы на запись идут в новую `master` ноду. Иногда процесс выбора новой главной ноды выполняется вручную, через изменение конфигурации, а иногда автоматически.

### master-master (одноранговая, P2P)
В этом варианте все ноды главные - `master`. Каждая нода умеет обрабатывать запросы на запись и на чтение. После записи данных на одну ноду, данные синхронизируются на другие ноды в асинхронном режиме.

В случае выхода из стоя одной `master` ноды, остальные продолжают работать. Реконфигурация в данном случае не требуется.

### Синхронная и Асинхронная

### Кворум

## Комбинации
Теорема гласит, что можно выбрать максимум два из трех выше описанных свойств.

### CP
Система согласована, каждый запрос всегда возвращает свежие данные. Но когда происходят сетевые проблемы, часть системы может стать недоступной. 

Под это определение подходит `master-slave` репликация, один из `slave` может стать недоступным для чтения, но `master` продолжит принимать запросы на записи и чтение.

Еще можно привести пример с двумя дата центрами. У нас есть два дата центра. В какой то момент соединение между ними теряется. Второй дата центр должен перестать принимать запросы на чтение и запись, а приложения работавшие с этим дата центром, должны переключиться на первый рабочий дата центр.

### AP
Система доступна, но при сетевых проблемах разные ноды могут выдавать разные данные, на один и тот же запрос, потому что они работают независимо. Но после восстановления сети, система придет в согласованное состояние. По сути мы получает Eventual Consistency систему. 

Под это определение подходит `master-master` конфигурация, в которой каждая нода может независимо обрабатывать запросы на запись и чтение и при потере связи, репликация останосится, но ноды продолжат работать независимо, хоть и не будут знать об новых данных друг у друга.

Так же возможна и `master-slave` конфигурация, при потере связанности `slave` продолжит выполнять запросы на чтение, но он будет отдавать только старые данные, потому что о новых он ничего не знает.

В примере с двумя дата центрами, когда между ними происходит разрыв соединения, оба дата центра становятся на время независимыми и не видят обновления друг у друга, в результате чего часть данных в них устаревает до момента возобновления соединения.

### CA
Так как CAP, теорема доказана для распределенных систем, нельзя пожертвовать `Partition tolerance`, потому что распределенная система всегда имеет дело с сетью. Максимум что можно отнести к этой категории, это базы данных, которые установлены на один физический сервер.

## Типы баз данных
Сложно отнести современные БД к одной категории. Например для Cassandra можно настроить
MySQL может быть CP или AP в зависимости от конфигурации.


## Недостатки CAP-теоремы

## Дальнейшее чтение
* [Big Data World, Part 5: CAP Theorem](https://blog.jetbrains.com/blog/2021/06/03/big-data-world-part-5-cap-theorem/)
* [Мифы о CAP теореме](https://habr.com/ru/post/322276/)
* [Please stop calling databases CP or AP](https://martin.kleppmann.com/2015/05/11/please-stop-calling-databases-cp-or-ap.html) ([Перевод на русский](https://habr.com/ru/post/258145/))
